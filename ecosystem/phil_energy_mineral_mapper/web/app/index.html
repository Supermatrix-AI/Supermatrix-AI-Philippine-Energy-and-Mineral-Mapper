<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>PHEMM â€” Supermatrix-AI (PH Energy & Mineral Mapper)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .legend { background:#fff; padding:8px; border-radius:8px; line-height:1.2; }
  .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eee; margin-right:6px;}
</style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([12.8797, 121.7740], 6);
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(map);

const urlParams = new URLSearchParams(window.location.search);
const rasterSrc = urlParams.get("src");
const raster = L.tileLayer(`/tiles/{z}/{x}/{y}${rasterSrc ? ("?src="+encodeURIComponent(rasterSrc)) : ""}`, {
  maxZoom: 19, opacity: 0.8, attribution: "Supermatrix-AI PHEMM"
}).addTo(map);

fetch("/geojson").then(r => r.json()).then(async ({ geojson }) => {
  for (const rel of geojson) {
    try {
      const resp = await fetch("/geojson/get?path=" + encodeURIComponent(rel));
      const data = await resp.json();
      const layer = L.geoJSON(data, {
        style: { color: "#007acc", weight: 1.25, fillOpacity: 0.1 }
      }).addTo(map);
      layer.bindPopup(`<div class="legend"><span class="badge">GeoJSON</span>${rel}</div>`);
      if (!map._firstFit) {
        map.fitBounds(layer.getBounds());
        map._firstFit = true;
      }
    } catch (err) {
      console.warn("Failed to load", rel, err);
    }
  }
});
</script>
</body>
</html>
